# Halo Notes 发布排版规范 v2

> 目标：把「X 链接 → Halo Notes 上线」做成稳定可复用流水线，确保全文完整、插图位置正确、发布可回溯。

## 0. 适用范围
- 来源：`x.com` / `twitter.com` 链接（推文或 X Article）
- 输出：`halo-notes/articles/*.md` + `articles.json` 元数据
- 要求：正文可导航、插图在正文语义位置、可直接发布

## 1. 数据提取优先级（必须）
1. 优先使用 Twitter API 返回的 `article.plain_text`（完整正文）。
2. 若无 `article.plain_text`，再使用 tweet 文本 + 线程补全。
3. 禁止仅用网页可见片段替代全文。

## 2. 文档头部（必须）
每篇文章必须以如下结构开头：

```md
# 标题

- 原始链接：<...>
- 作者：...（@...）
- 发布时间：...
- X Article：<...>

---
```

## 3. 插图放置规则（必须）

### 3.1 基础规则
- 图 1 作为封面：放在 `---` 后、正文第一段前。
- 其余图片必须“就近插入”对应章节，不再统一堆在文末图集。
- 图片使用标准 Markdown：

```md
![](https://...)
```

### 3.2 章节锚点策略（长文默认）
当文章是结构化长文（如“一、二、三...”）时，按章节锚点插图：
- 图2 → 第二章前
- 图3 → 第四章前
- 图4 → 第五章前
- 图5 → 第七章前
- 图6 → 第八章前
- 图7 → 第十章前

若原文章节数/配图数不匹配：
- 优先保持“语义邻近”（相关段落前后）。
- 不得打断引用、代码块、列表的连续性。

## 4. 标题层级与可导航性（必须）
- 主章节：`##`
- 子章节：`###`
- 禁止跳级（例如 `##` 直接到 `####`）
- 文章 >600 字建议至少 3 个 `##`

## 5. 清洗规则（必须）
- 删除乱码替代字符：`U+FFFD`（`�`）
- 合并多余空行（最多保留 1 个空行）
- 去除相邻重复段落
- 统一中英文标点和空格（不做过度“润色改写”）

## 6. 元数据同步（必须）
更新 `articles.json`：
- `title`、`file`、`date`、`source`
- `summary`（1 句，强调价值）
- `cover`（默认取图1）
- `quality`：
  - `S`：`article.plain_text` 全文 + 插图正确落位
  - `A`：正文完整，存在轻度人工整理
  - `B`：仅预览/待补全文

## 7. 发布前质量门（必须）
- [ ] 全文来源正确（优先 `article.plain_text`）
- [ ] 文档头部完整
- [ ] 插图不是文末堆叠，且位置语义正确
- [ ] 无乱码字符 `�`
- [ ] 标题层级可生成目录
- [ ] `articles.json` 已同步
- [ ] 本地 diff 仅包含预期变更

## 8. Git 发布流程（必须）
```bash
# 在 halo-notes 仓库内
git status
git add articles/<文件名>.md articles.json docs/markdown_publish_spec_v1.md
git commit -m "更新文章：全文+插图落位+元数据"
git push
```

## 9. 回滚与修复
- 发布后发现图片错位：直接修 md 并二次 commit（禁止“口头说明已修复”）。
- 若全文抽取异常：保留原文链接，标记 `quality=B`，并在后续补全再升级质量等级。

## 10. 默认执行口径（给助手）
- 收到“提取全文包括插图到 halos 网站”时，默认执行：
  1) 抽取全文（API）
  2) 插图按正文锚点落位
  3) 更新 `articles.json`
  4) commit + push
  5) 回报 commit hash
