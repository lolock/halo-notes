<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÊñáÁ´†ÈòÖËØª - Halo Notes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script>
    (function(){
      const saved = localStorage.getItem('halo_theme');
      let theme = saved;
      if(!theme){ const h=new Date().getHours(); theme=(h>=7&&h<19)?'light':'dark'; }
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{--bg:#0a0a0a;--panel:#141414;--text:#f1f5f9;--muted:#94a3b8;--line:#262626;--accent:#00ff41;--accent2:#00ffff;--code:#070b16;--codeText:#d7e1ff}
    [data-theme="light"]{--bg:#f8fafc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--line:#dbe3ef;--accent:#16a34a;--accent2:#0369a1;--code:#eef2ff;--codeText:#1e293b}
    *{box-sizing:border-box}
    html,body{width:100%;max-width:100%;overflow-x:hidden!important}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"IBM Plex Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft Yahei",sans-serif}
    .mono{font-family:"JetBrains Mono",ui-monospace,monospace}
    .wrap{width:min(1200px,100%);margin:0 auto;padding:18px 12px 46px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .top a{color:var(--accent2);text-decoration:none;font-size:14px}
    .themeBtn{border:1px solid var(--line);background:var(--panel);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}

    .layout{display:grid;grid-template-columns:minmax(0,1fr) 300px;gap:16px;align-items:start}
    .paper{width:100%;background:linear-gradient(180deg,rgba(0,255,65,.04),transparent 120px),var(--panel);border:1px solid var(--line);border-radius:14px;padding:20px 16px;box-shadow:0 20px 50px -10px rgba(0,0,0,.35);overflow:hidden}
    .side{position:sticky;top:14px;height:calc(100vh - 28px)

    .tocCard{border:1px dashed rgba(0,255,65,.35);border-radius:10px;background:rgba(0,255,65,.05);padding:10px}
    .tocTitle{display:block;color:var(--accent);margin-bottom:8px;font-weight:600}
    .tocList{height:calc(100vh - 170px);overflow:auto;padding-right:4px}
    .toc-link{display:block;padding:4px 0 4px 8px;border-left:2px solid transparent;color:var(--accent2);text-decoration:none;font-size:14px;line-height:1.4}
    .toc-link.active{border-left-color:var(--accent);color:var(--accent);background:rgba(34,197,94,.10);border-radius:6px}
    .progressWrap{margin-top:10px;border:1px solid var(--line);border-radius:999px;height:8px;overflow:hidden;background:rgba(148,163,184,.2)}
    .progressBar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}

    .content{max-width:100%;overflow:hidden;overflow-wrap:anywhere;word-break:break-word}
    .content *{max-width:100%}
    .content h1,.content h2,.content h3{line-height:1.35;margin-top:1.2em;scroll-margin-top:84px}
    .content h1{font-size:30px;letter-spacing:-.02em}
    .content p,.content li{line-height:1.9}
    .content img{max-width:100%;height:auto;border-radius:10px}
    .content pre{overflow:auto;background:var(--code);color:var(--codeText);padding:12px;border-radius:10px;border:1px solid rgba(0,255,65,.2)}
    .content code{font-family:"JetBrains Mono",ui-monospace,monospace}
    .content blockquote{border-left:3px solid rgba(0,255,65,.45);padding-left:12px;color:var(--muted);margin-left:0}
    .content a{display:inline-block;max-width:100%;overflow-wrap:anywhere;word-break:break-all;white-space:normal;vertical-align:bottom;color:var(--accent2)}
    .content ul,.content ol{padding-left:1.2em}
    .tocListM{max-height:44vh;overflow:auto}

    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .side{display:none}
                }
    @media (max-width:640px){.content h1{font-size:24px}.content h2{font-size:20px}.content h3{font-size:18px}.content p,.content li{font-size:16px}}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="top">
      <a href="./index.html">‚Üê ËøîÂõûÁõÆÂΩï</a>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="themeToggle" class="themeBtn mono" type="button">üåô Â§úÈó¥</button>
        <a id="raw" href="#" target="_blank" rel="noopener" class="mono">Êü•ÁúãÂéüÂßã Markdown</a>
      </div>
    </div>

    <section class="layout">
      <article class="paper content" id="content">Âä†ËΩΩ‰∏≠‚Ä¶</article>
      <aside class="side">
        <div class="tocCard">
          <span class="tocTitle">ÁõÆÂΩï</span>
          <div id="tocLinks" class="tocList"></div>
          <div class="progressWrap"><div id="progressBar" class="progressBar"></div></div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    marked.setOptions({breaks:true,gfm:true});
    const p = new URLSearchParams(location.search);
    const file = p.get('file');
    const el = document.getElementById('content');
    const raw = document.getElementById('raw');
    const themeToggle=document.getElementById('themeToggle');

    function syncThemeBtn(){
      const t=document.documentElement.getAttribute('data-theme')||'dark';
      themeToggle.textContent = t==='light' ? '‚òÄÔ∏è Êó•Èó¥' : 'üåô Â§úÈó¥';
    }
    themeToggle.addEventListener('click',()=>{
      const now=document.documentElement.getAttribute('data-theme')||'dark';
      const next= now==='light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme',next);
      localStorage.setItem('halo_theme',next);
      syncThemeBtn();
    });
    syncThemeBtn();


    function compactLongLinks(container){
      const links=[...container.querySelectorAll('a[href]')];
      links.forEach(a=>{
        const href=a.getAttribute('href')||'';
        const txt=(a.textContent||'').trim();
        if(!(txt.length>48 || href.length>72)) return;
        try{ const u=new URL(href, location.origin); const short=u.pathname.length>16?u.pathname.slice(0,16)+'‚Ä¶':u.pathname; a.textContent=`${u.host}${short}`; a.title=href; }
        catch{ a.textContent=txt.slice(0,28)+'‚Ä¶'; a.title=href||txt; }
      });
    }

    function hardenOverflow(container){
      const nodes=[container,...container.querySelectorAll('*')];
      nodes.forEach(n=>{ try{ if(n.scrollWidth>n.clientWidth+1){ n.style.maxWidth='100%'; n.style.overflowWrap='anywhere'; n.style.wordBreak=n.tagName==='A'?'break-all':'break-word'; n.style.whiteSpace='normal'; } }catch{} });
    }

    function ensureVisible(container, item){
      if(!container || !item) return;
      const top=item.offsetTop, bottom=top+item.offsetHeight;
      const viewTop=container.scrollTop, viewBottom=viewTop+container.clientHeight;
      if(top<viewTop) container.scrollTop=top-12;
      else if(bottom>viewBottom) container.scrollTop=bottom-container.clientHeight+12;
    }

    function buildToc(container){
      const hs=[...container.querySelectorAll('h2,h3')];
      const desktop=document.getElementById('tocLinks');
      const mobile=document.getElementById('tocLinksMobile');
      desktop.innerHTML=''; mobile.innerHTML='';
      hs.forEach((h,i)=>{
        if(!h.id) h.id='sec-'+i;
        const t=(h.tagName==='H3'?'‚Ü≥ ':'')+h.textContent;
        const a=document.createElement('a'); a.href='#'+h.id; a.className='toc-link'; a.textContent=t; desktop.appendChild(a);
        const b=document.createElement('a'); b.href='#'+h.id; b.className='toc-link'; b.textContent=t; mobile.appendChild(b);
      });
      return hs;
    }

    function bindReadingSync(headings){
      if(!headings || !headings.length) return;
      const links=[...document.querySelectorAll('#tocLinks .toc-link')];
      const linksM=[...document.querySelectorAll('#tocLinksMobile .toc-link')];
      const list=document.getElementById('tocLinks');
      const listM=document.getElementById('tocLinksMobile');
      const bar=document.getElementById('progressBar');
      const barM=document.getElementById('progressBarMobile');

      const onScroll=()=>{
        const d=document.documentElement;
        const max=d.scrollHeight-d.clientHeight;
        const pct=max>0?Math.max(0,Math.min(100,(window.scrollY/max)*100)):0;
        bar.style.width=pct.toFixed(1)+'%';
        barM.style.width=pct.toFixed(1)+'%';

        let active=0;
        headings.forEach((h,i)=>{ if(h.getBoundingClientRect().top<=140) active=i; });
        links.forEach((l,i)=>l.classList.toggle('active',i===active));
        linksM.forEach((l,i)=>l.classList.toggle('active',i===active));

        ensureVisible(list, links[active]);
        ensureVisible(listM, linksM[active]);
      };

      window.addEventListener('scroll', onScroll, {passive:true});
      window.addEventListener('resize', onScroll);
      onScroll();
    }

    if(!file){ el.textContent='Áº∫Â∞ë file ÂèÇÊï∞'; }
    else {
      raw.href='./articles/'+encodeURIComponent(file);
      fetch('./articles/'+encodeURIComponent(file))
        .then(r=>{ if(!r.ok) throw new Error('ËØªÂèñÂ§±Ë¥•'); return r.text(); })
        .then(md=>{
          el.innerHTML = marked.parse(md);
          compactLongLinks(el);
          hardenOverflow(el);
          const hs=buildToc(el);
          bindReadingSync(hs);
          document.title=(md.match(/^#\s+(.+)/m)?.[1]||'ÊñáÁ´†ÈòÖËØª')+' - Halo Notes';
        })
        .catch(e=>{ el.textContent='Âä†ËΩΩÂ§±Ë¥•Ôºö'+e.message; });
    }
  </script>
</body>
</html>
